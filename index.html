<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sistan Quiz Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        :root { --brand-blue: #0ea5e9; }
        html, body { 
            position: fixed; width: 100%; height: 100%; overflow: hidden;
            font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; 
            touch-action: none; -webkit-user-select: none; user-select: none;
        }
        #app { height: 100dvh; width: 100%; display: flex; flex-direction: column; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 2rem; box-shadow: 0 10px 30px -5px rgba(14, 165, 233, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #38bdf8, #0ea5e9); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3); transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.96); }
        .choice-btn { background: white; border: 2px solid #e2e8f0; transition: all 0.1s; touch-action: manipulation; }
        .ans-correct { background-color: #10b981 !important; color: white !important; border-color: #10b981 !important; }
        .ans-wrong { background-color: #ef4444 !important; color: white !important; border-color: #ef4444 !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
<div id="app" class="max-w-md mx-auto"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const sounds = {
    start: new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3'),
    correct: new Audio('https://assets.mixkit.co/active_storage/sfx/1915/1915-preview.mp3'),
    wrong: new Audio('https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3'),
    click: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3')
};

const firebaseConfig = {
    apiKey: "AIzaSyDgKn9xhqpEoEtR_TN_MG9AzqBuopKnZPs",
    authDomain: "sistan-test-cef7d.firebaseapp.com",
    projectId: "sistan-test-cef7d",
    storageBucket: "sistan-test-cef7d.firebasestorage.app",
    messagingSenderId: "327690628441",
    appId: "1:327690628441:web:63bf4af9942f386b8f3048"
};
const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);

// --- 全2027語データ ---
const wordData = [
    {id:1, en:"follow", ja:"～に従う"}, {id:2, en:"consider", ja:"～を考慮する"}, {id:3, en:"increase", ja:"増える"}, {id:4, en:"expect", ja:"～を予期する"}, {id:5, en:"decide", ja:"～を決意する"}, {id:6, en:"develop", ja:"発達する"}, {id:7, en:"provide", ja:"～を供給する"}, {id:8, en:"continue", ja:"続く"}, {id:9, en:"include", ja:"～を含む"}, {id:10, en:"remain", ja:"ままでいる"},
    {id:11, en:"reach", ja:"～に達する"}, {id:12, en:"allow", ja:"～を許可する"}, {id:13, en:"force", ja:"～を強制する"}, {id:14, en:"offer", ja:"～を申し出る"}, {id:15, en:"realize", ja:"～を悟る"}, {id:16, en:"suggest", ja:"～を提案する"}, {id:17, en:"require", ja:"～を必要とする"}, {id:18, en:"worry", ja:"心配する"}, {id:19, en:"wonder", ja:"～かと疑問に思う"}, {id:20, en:"cost", ja:"～を要する"}
];
// ダミーデータ補完（実際はここに全定義が入ります）
for(let i=21; i<=2027; i++){ wordData.push({id:i, en:`Word ${i}`, ja:`意味 ${i}`}); }

const ADMIN_PASS = "Henly0402";
let state = { view: 'loading', currentUser: null, users: [], quiz: null, quizType: null };

async function fetchUsers() {
    const querySnapshot = await getDocs(collection(db, "users"));
    state.users = querySnapshot.docs.map(doc => doc.data());
    state.view = 'login'; render();
}
async function syncUser(user) { await setDoc(doc(db, "users", user.id), user); }

document.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });

window.render = function() {
    const root = document.getElementById('app');
    if (state.view === 'loading') { root.innerHTML = `<div class="h-full flex items-center justify-center text-sky-500 font-bold tracking-widest">LOADING...</div>`; }
    else if (state.view === 'login') {
        root.innerHTML = `<div class="h-full flex flex-col justify-center p-8 fade-in">
            <div class="glass-card p-10 relative text-center">
                <button onclick="adminAuth()" class="absolute top-6 left-1/2 -translate-x-1/2 text-[11px] text-slate-300 font-bold border border-slate-100 px-3 py-1 rounded-full active:bg-slate-50">管理者ログイン</button>
                <div class="mt-8 mb-10">
                    <h1 class="text-4xl font-black text-sky-500 tracking-tight">SISTAN</h1>
                    <p class="text-[10px] text-slate-400 font-bold tracking-[0.2em] uppercase mt-1">Smart Learning</p>
                </div>
                <div class="space-y-4 text-left">
                    <input id="uID" type="text" placeholder="ユーザーID" class="w-full p-5 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-sky-100 transition">
                    <input id="uPW" type="password" placeholder="パスワード" class="w-full p-5 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-sky-100 transition">
                    <button onclick="doLogin()" class="w-full py-5 btn-primary text-white rounded-3xl font-bold text-lg shadow-lg">ログイン</button>
                </div>
            </div>
        </div>`;
    }
    else if (state.view === 'home') {
        root.innerHTML = `<div class="p-8 h-full flex flex-col fade-in">
            <div class="flex justify-between items-end mb-12">
                <div><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Mastery App</p><h2 class="text-3xl font-black text-slate-800">${state.currentUser.id}</h2></div>
                <button onclick="location.reload()" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-red-400 font-bold">✕</button>
            </div>
            <div class="flex-1 space-y-4">
                <button onclick="showRange('Basic')" class="w-full py-8 glass-card text-left px-8 group active:bg-sky-50 transition">
                    <span class="block text-[10px] font-bold text-sky-400 mb-1 uppercase tracking-widest">Stage 01</span>
                    <span class="text-xl font-bold text-slate-700">Basicコース</span>
                </button>
                <button onclick="showRange('Standard')" class="w-full py-8 glass-card text-left px-8 group active:bg-sky-50 transition">
                    <span class="block text-[10px] font-bold text-sky-400 mb-1 uppercase tracking-widest">Stage 02</span>
                    <span class="text-xl font-bold text-slate-700">Standardコース</span>
                </button>
                <button onclick="showRange('Master')" class="w-full py-12 btn-primary rounded-[2.5rem] text-white text-center shadow-xl transition active:scale-95">
                    <span class="block text-[10px] font-bold opacity-70 mb-1 uppercase tracking-widest">Challenge</span>
                    <span class="text-2xl font-black">Master Mode</span>
                </button>
            </div>
        </div>`;
    }
    else if (state.view === 'range') {
        let btnStr = "";
        if(state.quizType === 'Basic') { for(let i=1; i<=600; i+=100) btnStr += `<button onclick="startQuiz(${i}, ${i+99})" class="w-full p-6 glass-card font-bold text-slate-600 active:bg-sky-50">${i} ～ ${i+99}</button>`; }
        else if(state.quizType === 'Standard') { for(let i=601; i<=1600; i+=400) btnStr += `<button onclick="startQuiz(${i}, ${Math.min(i+399, 1600)})" class="w-full p-6 glass-card font-bold text-slate-600 active:bg-sky-50">${i} ～ ${Math.min(i+399, 1600)}</button>`; }
        else {
            root.innerHTML = `<div class="h-full flex flex-col items-center justify-center p-8 text-center fade-in">
                <div class="text-[10px] text-sky-400 font-bold mb-4 uppercase tracking-widest">Total Mastery Points</div>
                <div class="text-8xl font-black text-slate-800 tracking-tighter mb-12">${state.currentUser.progress}</div>
                <button onclick="startQuiz(1, 2027)" class="w-full py-6 btn-primary text-white rounded-[2rem] font-black text-xl shadow-xl">テスト開始</button>
                <button onclick="state.view='home'; render()" class="mt-8 text-slate-400 font-bold uppercase text-xs tracking-widest">ホームに戻る</button>
            </div>`; return;
        }
        root.innerHTML = `<div class="p-8 h-full flex flex-col fade-in"><h2 class="text-3xl font-black mb-8 text-slate-800 tracking-tight">範囲を選択</h2><div class="flex-1 space-y-3 overflow-y-auto pb-10 scrollbar-hide">${btnStr}</div><button onclick="state.view='home'; render()" class="py-4 text-slate-400 font-bold">戻る</button></div>`;
    }
    else if (state.view === 'quiz') {
        const q = state.quiz.questions[state.quiz.curr];
        const prog = ((state.quiz.curr + 1) / 20) * 100;
        root.innerHTML = `<div class="h-full flex flex-col p-6 fade-in">
            <div class="w-full h-1.5 bg-slate-100 rounded-full mt-4 overflow-hidden"><div class="h-full bg-sky-400 transition-all duration-300" style="width: ${prog}%"></div></div>
            <div class="flex-1 flex flex-col justify-center items-center text-center">
                <span class="text-[10px] font-bold text-sky-300 mb-2 uppercase tracking-widest">Question ${state.quiz.curr + 1}</span>
                <h2 class="text-6xl font-black text-slate-800 tracking-tighter leading-tight">${q.en}</h2>
            </div>
            <div class="grid gap-3 mb-4">
                ${q.choices.map((c, i) => `<button id="c-${i}" onclick="check(${i})" class="choice-btn w-full p-5 rounded-2xl font-bold text-left text-slate-700 shadow-sm active:bg-sky-50 border-2 border-slate-100">${c}</button>`).join('')}
            </div>
            <button onclick="check(-1)" class="w-full p-5 bg-slate-50 text-slate-300 rounded-2xl font-bold mb-10 text-sm">わからない</button>
        </div>`;
    }
    else if (state.view === 'result') {
        root.innerHTML = `<div class="h-full flex flex-col items-center justify-center p-8 fade-in">
            <div class="glass-card w-full p-12 text-center">
                <h2 class="text-xs font-bold text-sky-400 mb-2 uppercase tracking-widest">Score</h2>
                <div class="text-8xl font-black text-slate-800 mb-12">${state.quiz.score}<span class="text-2xl text-slate-200">/20</span></div>
                <button onclick="state.view='home'; render()" class="w-full py-5 btn-primary text-white rounded-2xl font-black shadow-lg">ホームに戻る</button>
            </div>
        </div>`;
    }
    else if (state.view === 'admin') {
        root.innerHTML = `<div class="p-8 h-full flex flex-col fade-in">
            <h2 class="text-3xl font-black mb-8 text-slate-800 tracking-tight">管理者設定</h2>
            <div class="glass-card p-6 mb-6">
                <p class="text-[10px] font-bold text-sky-400 mb-4 uppercase">新規ユーザーを登録</p>
                <input id="nID" type="text" placeholder="ユーザーID" class="w-full p-4 bg-slate-50 rounded-xl mb-2 outline-none">
                <input id="nPW" type="text" placeholder="パスワード" class="w-full p-4 bg-slate-50 rounded-xl mb-4 outline-none">
                <button onclick="registerUser()" class="w-full py-4 btn-primary text-white rounded-xl font-bold">アカウント作成</button>
            </div>
            <div class="flex-1 glass-card overflow-hidden flex flex-col">
                <div class="p-4 bg-sky-50 text-[10px] font-bold text-sky-400 uppercase tracking-widest">User Progress</div>
                <div class="flex-1 overflow-y-auto">
                    ${state.users.map(u => `<div class="p-4 border-t flex justify-between items-center font-bold text-sm"><span>${u.id}</span><span class="bg-sky-100 text-sky-600 px-3 py-1 rounded-full text-[10px]">${u.progress}pt</span></div>`).join('')}
                </div>
            </div>
            <button onclick="state.view='login'; render()" class="py-6 text-slate-400 font-bold uppercase text-xs">管理画面を閉じる</button>
        </div>`;
    }
};

window.adminAuth = () => { sounds.click.play(); if(prompt("管理者パスワードを入力してください") === ADMIN_PASS) { state.view = 'admin'; render(); } };
window.registerUser = async () => { sounds.click.play(); const id=document.getElementById('nID').value, pw=document.getElementById('nPW').value; if(id&&pw){ await syncUser({id, pass:pw, progress:0}); await fetchUsers(); alert("登録が完了しました"); } };
window.doLogin = () => { const id=document.getElementById('uID').value, pw=document.getElementById('uPW').value; const u=state.users.find(x=>x.id===id&&x.pass===pw); if(u){ state.currentUser=u; state.view='home'; sounds.start.play(); render(); }else{ sounds.wrong.play(); alert("IDまたはパスワードが正しくありません"); } };
window.showRange = (type) => { sounds.click.play(); state.quizType=type; state.view='range'; render(); };
window.startQuiz = (min, max) => {
    sounds.click.play();
    let pool = wordData.filter(w => w.id >= min && w.id <= max);
    let qs = [];
    for(let i=0; i<20; i++){
        if(pool.length===0) break;
        const t = pool.splice(Math.floor(Math.random()*pool.length), 1)[0];
        let cs = [t.ja];
        while(cs.length<4){ let r=wordData[Math.floor(Math.random()*wordData.length)].ja; if(!cs.includes(r)) cs.push(r); }
        qs.push({...t, choices: cs.sort(()=>Math.random()-0.5)});
    }
    state.quiz = { questions: qs, curr: 0, score: 0 }; state.view = 'quiz'; render();
};
window.check = async (idx) => {
    const q = state.quiz.questions[state.quiz.curr];
    const ok = (idx!==-1 && q.choices[idx]===q.ja);
    if(ok){ sounds.correct.play(); state.quiz.score++; if(state.quizType==='Master'){ state.currentUser.progress++; await syncUser(state.currentUser); } }
    else { sounds.wrong.play(); }
    if(idx!==-1) document.getElementById(`c-${idx}`).classList.add(ok?'ans-correct':'ans-wrong');
    setTimeout(()=>{ if(state.quiz.curr<state.quiz.questions.length-1){ state.quiz.curr++; render(); }else{ state.view='result'; render(); } }, 400);
};

fetchUsers();
</script>
</body>
</html>
